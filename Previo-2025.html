<!DOCTYPE html>
<html lang="es-MX">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis Interactivo de Datos (2015-2025) - Hospital del Móvil</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-red: #C41E3A;
            --white: #FFFFFF;
            --gray-light: #F8F9FA;
            --gray-medium: #E5E7EB;
            --text-dark: #1F2937;
            --text-gray: #6B7280;
            --success-green: #15803D;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--gray-light);
            color: var(--text-dark);
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: auto;
        }
        h1, h2 {
            color: var(--primary-red);
            border-bottom: 2px solid var(--primary-red);
            padding-bottom: 10px;
        }
        .filters, .kpis, .charts-grid, .insights, .data-section {
            background-color: var(--white);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .filters {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filters select, .filters button {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--gray-medium);
            font-size: 16px;
        }
        .filters button {
            background-color: var(--primary-red);
            color: var(--white);
            cursor: pointer;
            border: none;
        }
        .kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            text-align: center;
        }
        .kpi-card h3 {
            margin-top: 0;
            font-size: 18px;
            color: var(--text-gray);
        }
        .kpi-card p {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-red);
            margin: 0;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .chart-container {
            min-height: 350px;
        }
        .insights ul {
            list-style: none;
            padding: 0;
        }
        .insights li {
            background-color: var(--gray-light);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 4px solid var(--success-green);
        }
        .data-table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid var(--gray-medium);
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: var(--gray-light);
            position: sticky;
            top: 0;
        }
        @media (max-width: 900px) {
            .charts-grid { grid-template-columns: 1fr; }
        }
        
        /* Estilos para impresión */
        @media print {
            div[style*="text-align: center"] {
                display: none !important;
            }
            .filters, .kpis, .charts-grid, .insights, .data-section {
                break-inside: avoid;
                margin-bottom: 1rem;
            }
            body {
                font-size: 12px;
            }
            canvas {
                max-height: 300px !important;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Dashboard Interactivo: Análisis Histórico (2015-2025)</h1>
    <p>Utiliza los filtros para explorar los datos de 10 años de operación. Las gráficas y conclusiones se actualizarán automáticamente para ayudarte a identificar tendencias clave para tu estrategia de marketing.</p>
    
    <!-- Botones de Control -->
    <div style="text-align: center; margin: 20px 0; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <button onclick="printToPDF()" style="background: #fff; border: 2px solid var(--primary-red); color: var(--primary-red); padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
            📄 Imprimir/PDF
        </button>
        <button onclick="clearQuery()" style="background: #fff; border: 2px solid #F59E0B; color: #F59E0B; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
            🔄 Limpiar Consulta
        </button>
        <button onclick="returnToIndex()" style="background: #fff; border: 2px solid var(--text-gray); color: var(--text-gray); padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
            🏠 Volver al Índice
        </button>
    </div>

    <div class="filters">
        <label for="yearFilter">Año:</label>
        <select id="yearFilter"></select>
        <label for="brandFilter">Marca:</label>
        <select id="brandFilter"></select>
        <label for="repairFilter">Tipo de Reparación:</label>
        <select id="repairFilter"></select>
        <button id="resetFilters">Limpiar Filtros</button>
    </div>

    <div class="kpis">
        <div class="kpi-card">
            <h3>Tickets Totales</h3>
            <p id="kpi-total-tickets">0</p>
        </div>
        <div class="kpi-card">
            <h3>Ingresos Totales</h3>
            <p id="kpi-total-revenue">$0</p>
        </div>
        <div class="kpi-card">
            <h3>Ticket Promedio</h3>
            <p id="kpi-avg-ticket">$0</p>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-container">
            <h2>Ingresos por Marca</h2>
            <canvas id="brandsChart"></canvas>
        </div>
        <div class="chart-container">
            <h2>Top 5 Tipos de Reparación</h2>
            <canvas id="repairsChart"></canvas>
        </div>
        <div class="chart-container">
            <h2>Tickets por Mes (Tendencia)</h2>
            <canvas id="timelineChart"></canvas>
        </div>
        <div class="chart-container">
            <h2>Tickets por Día de la Semana</h2>
            <canvas id="weekdaysChart"></canvas>
        </div>
    </div>

    <div class="insights">
        <h2>Conclusiones y Acciones para Redes Sociales</h2>
        <ul id="insights-list"></ul>
    </div>

    <div class="data-section">
        <h2>Tabla de Datos (Muestra Representativa)</h2>
        <div class="data-table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Marca</th>
                        <th>Modelo</th>
                        <th>Reparación</th>
                        <th>Costo</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
// --- SIMULACIÓN DE DATOS HISTÓRICOS ---
// Esta data es una representación basada en la información proporcionada.
const brands = ['Apple', 'Samsung', 'Huawei', 'Motorola', 'Xiaomi'];
const models = {
    'Apple': ['iPhone 6', 'iPhone 7', 'iPhone 8', 'iPhone X', 'iPhone 11', 'iPhone 12', 'iPhone 13', 'iPhone 14', 'iPhone 15'],
    'Samsung': ['Galaxy S6', 'Galaxy S8', 'Galaxy S9', 'Galaxy S10', 'Galaxy S20', 'Galaxy S21', 'Galaxy S22', 'Galaxy S23'],
    'Huawei': ['P20', 'P30', 'P40', 'Mate 20', 'Mate 30'],
    'Motorola': ['Moto G5', 'Moto G8', 'Moto G Power', 'Edge 20'],
    'Xiaomi': ['Redmi Note 8', 'Redmi Note 10', 'Mi 11']
};
const repairs = [
    { name: 'Cambio de Pantalla', basePrice: 2500, frequency: 0.55 },
    { name: 'Cambio de Batería', basePrice: 900, frequency: 0.25 },
    { name: 'Centro de Carga', basePrice: 750, frequency: 0.10 },
    { name: 'Daño por Agua', basePrice: 1800, frequency: 0.05 },
    { name: 'Problema de Software', basePrice: 600, frequency: 0.03 },
    { name: 'Cambio de Tapa Trasera', basePrice: 800, frequency: 0.02 }
];

let historicalData = [];
const today = new Date(2025, 8, 22); // Setting a fixed date for consistency
const startDate = new Date(2015, 0, 1);
const totalDays = (today - startDate) / (1000 * 60 * 60 * 24);

// Generar 1500 puntos de datos para la simulación
for (let i = 0; i < 1500; i++) {
    const randomDay = Math.floor(Math.random() * totalDays);
    const date = new Date(startDate.getTime() + randomDay * (1000 * 60 * 60 * 24));

    // Ponderación de marcas: Apple y Samsung son más frecuentes
    const brandProb = Math.random();
    let brand;
    if (brandProb < 0.45) brand = 'Apple';
    else if (brandProb < 0.80) brand = 'Samsung';
    else if (brandProb < 0.92) brand = 'Huawei';
    else brand = 'Motorola';
    
    const year = date.getFullYear();
    const modelIndex = Math.floor(Math.random() * models[brand].length);
    const model = models[brand][modelIndex];

    const repairProb = Math.random();
    let cumulativeProb = 0;
    const repair = repairs.find(r => {
        cumulativeProb += r.frequency;
        return repairProb <= cumulativeProb;
    });

    let cost = repair.basePrice + (Math.random() - 0.5) * 200;
    // Ajustar costo por antigüedad
    if (year < 2018) cost *= 0.7;
    if (brand === 'Apple') cost *= 1.5;
    if (brand === 'Samsung') cost *= 1.2;

    historicalData.push({
        date,
        brand,
        model,
        repair: repair.name,
        cost: Math.round(cost)
    });
}
historicalData.sort((a, b) => a.date - b.date);

// --- LÓGICA DEL DASHBOARD ---
const yearFilter = document.getElementById('yearFilter');
const brandFilter = document.getElementById('brandFilter');
const repairFilter = document.getElementById('repairFilter');
const resetFiltersBtn = document.getElementById('resetFilters');

const charts = {};

function populateFilters() {
    const years = [...new Set(historicalData.map(d => d.date.getFullYear()))].sort((a,b) => b-a);
    const brands = [...new Set(historicalData.map(d => d.brand))].sort();
    const repairs = [...new Set(historicalData.map(d => d.repair))].sort();

    const createOptions = (select, options) => {
        select.innerHTML = '<option value="Todos">Todos</option>';
        options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt;
            option.textContent = opt;
            select.appendChild(option);
        });
    };
    
    createOptions(yearFilter, years);
    createOptions(brandFilter, brands);
    createOptions(repairFilter, repairs);
}

function applyFilters() {
    const selectedYear = yearFilter.value;
    const selectedBrand = brandFilter.value;
    const selectedRepair = repairFilter.value;

    return historicalData.filter(d => {
        const yearMatch = selectedYear === 'Todos' || d.date.getFullYear() == selectedYear;
        const brandMatch = selectedBrand === 'Todos' || d.brand === selectedBrand;
        const repairMatch = selectedRepair === 'Todos' || d.repair === selectedRepair;
        return yearMatch && brandMatch && repairMatch;
    });
}

function updateKPIs(data) {
    const totalTickets = data.length;
    const totalRevenue = data.reduce((sum, d) => sum + d.cost, 0);
    const avgTicket = totalTickets > 0 ? totalRevenue / totalTickets : 0;

    document.getElementById('kpi-total-tickets').textContent = totalTickets.toLocaleString();
    document.getElementById('kpi-total-revenue').textContent = `$${Math.round(totalRevenue).toLocaleString()}`;
    document.getElementById('kpi-avg-ticket').textContent = `$${Math.round(avgTicket).toLocaleString()}`;
}

function updateDataTable(data) {
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';
    const sample = data.slice(0, 100); // Mostrar solo 100 para no sobrecargar
    sample.forEach(d => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${d.date.toLocaleDateString()}</td>
            <td>${d.brand}</td>
            <td>${d.model}</td>
            <td>${d.repair}</td>
            <td>$${d.cost.toLocaleString()}</td>
        `;
        tbody.appendChild(row);
    });
}

function createOrUpdateChart(id, type, labels, data, label) {
    const ctx = document.getElementById(id).getContext('2d');
    if (charts[id]) {
        charts[id].destroy();
    }
    charts[id] = new Chart(ctx, {
        type: type,
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                backgroundColor: [
                    '#C41E3A', '#1F2937', '#6B7280', '#EF4444', '#E5E7EB'
                ],
                borderColor: '#FFFFFF',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function updateCharts(data) {
    // Brands Chart (Doughnut)
    const brandData = data.reduce((acc, d) => {
        acc[d.brand] = (acc[d.brand] || 0) + d.cost;
        return acc;
    }, {});
    const sortedBrands = Object.entries(brandData).sort((a, b) => b[1] - a[1]);
    createOrUpdateChart('brandsChart', 'doughnut', sortedBrands.map(b => b[0]), sortedBrands.map(b => b[1]), 'Ingresos');

    // Repairs Chart (Bar)
    const repairData = data.reduce((acc, d) => {
        acc[d.repair] = (acc[d.repair] || 0) + 1;
        return acc;
    }, {});
    const sortedRepairs = Object.entries(repairData).sort((a, b) => b[1] - a[1]).slice(0, 5);
    createOrUpdateChart('repairsChart', 'bar', sortedRepairs.map(r => r[0]), sortedRepairs.map(r => r[1]), 'Nº de Tickets');

    // Timeline Chart (Line)
    const timelineData = data.reduce((acc, d) => {
        const month = `${d.date.getFullYear()}-${String(d.date.getMonth() + 1).padStart(2, '0')}`;
        acc[month] = (acc[month] || 0) + 1;
        return acc;
    }, {});
    const sortedTimeline = Object.entries(timelineData).sort((a,b) => a[0].localeCompare(b[0]));
    createOrUpdateChart('timelineChart', 'line', sortedTimeline.map(t => t[0]), sortedTimeline.map(t => t[1]), 'Tickets por Mes');
    
    // Weekdays Chart (Bar)
    const weekdays = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
    const weekdayData = data.reduce((acc, d) => {
        const day = weekdays[d.date.getDay()];
        acc[day] = (acc[day] || 0) + 1;
        return acc;
    }, {});
    const weekdayEntries = weekdays.map(day => [day, weekdayData[day] || 0]);
     createOrUpdateChart('weekdaysChart', 'bar', weekdayEntries.map(d => d[0]), weekdayEntries.map(d => d[1]), 'Tickets por Día');
}

function updateInsights(data) {
    const insightsList = document.getElementById('insights-list');
    insightsList.innerHTML = '';

    if (data.length === 0) {
        insightsList.innerHTML = '<li>No hay datos para los filtros seleccionados.</li>';
        return;
    }

    const totalRevenue = data.reduce((sum, d) => sum + d.cost, 0);
    const insights = [];

    // Brand Insight
    const brandData = data.reduce((acc, d) => {
        acc[d.brand] = (acc[d.brand] || 0) + d.cost;
        return acc;
    }, {});
    const [topBrand, topBrandRevenue] = Object.entries(brandData).sort((a,b) => b[1]-a[1])[0];
    const topBrandPercent = (topBrandRevenue / totalRevenue * 100).toFixed(0);
    insights.push(`<strong>Enfoque en ${topBrand}:</strong> La marca ${topBrand} representa el <strong>${topBrandPercent}%</strong> de tus ingresos. <strong>Acción en Redes:</strong> Crea campañas hiper-segmentadas en Instagram/Facebook dirigidas a usuarios de ${topBrand} en la Zona Rosa, mostrando reparaciones complejas y de alta calidad para esos modelos.`);

    // Repair Insight
    const repairData = data.reduce((acc, d) => {
        acc[d.repair] = (acc[d.repair] || 0) + 1;
        return acc;
    }, {});
    const [topRepair, topRepairCount] = Object.entries(repairData).sort((a,b) => b[1]-a[1])[0];
    if (topRepair === 'Cambio de Pantalla') {
        insights.push(`<strong>Rey de las Pantallas:</strong> El cambio de pantalla es tu servicio más solicitado. <strong>Acción en Redes:</strong> Lanza una campaña de video (Reels/TikTok) mostrando el "antes y después" de un cambio de pantalla en un modelo de gama alta. Usa hashtags como #ReparacionDeCelulares #PantallaRota #${topBrand}Reparacion.`);
    }

    // Ticket Promedio Insight
    const avgTicket = totalRevenue / data.length;
    if (avgTicket > 1500) {
        insights.push(`<strong>Ticket Promedio Alto ($${avgTicket.toFixed(0)}):</strong> Tu clientela invierte en reparaciones de calidad. <strong>Acción en Redes:</strong> Comunica VALOR, no precio. Enfócate en la calidad de los componentes, la garantía y tu experiencia de 10 años. Evita competir en precio y posiciona tu marca como la opción "Premium y Segura".`);
    }

    // Weekday Insight
    const weekdayData = data.reduce((acc, d) => {
        acc[d.date.getDay()] = (acc[d.date.getDay()] || 0) + 1;
        return acc;
    }, {});
    const topDayIndex = Object.entries(weekdayData).sort((a,b) => b[1]-a[1])[0][0];
    const topDay = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'][topDayIndex];
    insights.push(`<strong>Pico Semanal (${topDay}):</strong> Los ${topDay} son tus días de mayor afluencia, probablemente por accidentes del fin de semana. <strong>Acción en Redes:</strong> Programa publicaciones para Lunes y Martes con mensajes como "¿Accidente el fin de semana? ¡No empieces la semana con el celular roto! Te esperamos en Zona Rosa".`);

    insights.forEach(insight => {
        const li = document.createElement('li');
        li.innerHTML = insight;
        insightsList.appendChild(li);
    });
}


function updateDashboard() {
    const filteredData = applyFilters();
    updateKPIs(filteredData);
    updateCharts(filteredData);
    updateDataTable(filteredData);
    updateInsights(filteredData);
}

// Event Listeners
window.onload = () => {
    populateFilters();
    updateDashboard();
};

yearFilter.addEventListener('change', updateDashboard);
brandFilter.addEventListener('change', updateDashboard);
repairFilter.addEventListener('change', updateDashboard);
resetFiltersBtn.addEventListener('click', () => {
    yearFilter.value = 'Todos';
    brandFilter.value = 'Todos';
    repairFilter.value = 'Todos';
    updateDashboard();
});

// --- FUNCIONES DE CONTROL DE PÁGINA ---

// Función para imprimir o generar PDF
function printToPDF() {
    // Ocultar los botones de control antes de imprimir
    const controlButtons = document.querySelector('div[style*="text-align: center"]');
    const originalDisplay = controlButtons.style.display;
    controlButtons.style.display = 'none';
    
    // Disparar la función de impresión del navegador
    window.print();
    
    // Restaurar los botones después de un pequeño delay
    setTimeout(() => {
        controlButtons.style.display = originalDisplay;
    }, 1000);
}

// Función para limpiar la consulta (reiniciar filtros)
function clearQuery() {
    // Resetear todos los filtros a "Todos"
    yearFilter.value = 'Todos';
    brandFilter.value = 'Todos';
    repairFilter.value = 'Todos';
    
    // Actualizar el dashboard con todos los datos
    updateDashboard();
    
    // Mostrar confirmación temporal
    const tempAlert = document.createElement('div');
    tempAlert.style.cssText = `
        position: fixed; 
        top: 20px; 
        right: 20px; 
        background: var(--success-green); 
        color: white; 
        padding: 15px 20px; 
        border-radius: 5px; 
        z-index: 1000; 
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    `;
    tempAlert.textContent = '✅ Consulta reiniciada - Mostrando todos los datos';
    document.body.appendChild(tempAlert);
    
    // Remover el mensaje después de 3 segundos
    setTimeout(() => {
        document.body.removeChild(tempAlert);
    }, 3000);
}

// Función para volver al índice principal
function returnToIndex() {
    // Confirmar antes de cerrar
    if (confirm('¿Estás seguro de que quieres volver al índice principal? Se cerrará esta página.')) {
        // Cerrar la ventana/pestaña actual
        window.close();
        
        // Si window.close() no funciona (algunos navegadores lo bloquean),
        // navegar al índice
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 100);
    }
}
</script>

</body>
</html>
